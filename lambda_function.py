import os
import json
import boto3
import yara 

RULES_DIR = './Rules/'

def scan(file):
    findings = False
    rules = os.listdir(RULES_DIR)
    print('Scanning file:', file)
    for i, rule_path in enumerate(rules, start = 1):
        print('Running rule', rule_path, f'[{i}/{len(rules)}]', sep = '\t')
        rule = yara.compile(filepath = RULES_DIR + rule_path)
        matches = rule.match(file)
        if not matches:
            # No rule matched
            print('No match for this rule.')

        else:
            findings = True
            # Print file name and matched rule(s)
            for m in matches['main']:
                print(f'Match found: {file} (rule: {m["rule"]})')

    if findings:
        return f'File {file} marked as unsafe.'
    else:
        return f'File {file} marked as safe.'

def lambda_handler(event, context):

    # TODO implement
    print(event)
    bucket_name = event['Records'][0]['s3']['bucket']['name']
    object_key = event['Records'][0]['s3']['object']['key']
    destination = '/tmp/' + object_key

    s3 = boto3.client('s3')
    s3.download_file(bucket_name, object_key, destination)

    print(os.listdir('/tmp'))
    result = scan(destination)
    print(result)
    return {
        'statusCode': 200,
        'body': result
    }


